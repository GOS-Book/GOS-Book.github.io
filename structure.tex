%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% The Legrand Orange Book
% Structural Definitions File
% Version 2.0 (9/2/15)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	VARIOUS REQUIRED PACKAGES AND CONFIGURATIONS
%----------------------------------------------------------------------------------------

\usepackage[margin=1.6cm, top=1.2cm,right=1.9cm,left=1.9cm, footskip = 1 cm, headheight=20pt,headsep=0.2cm]{geometry}
%\geometry{showframe}

\usepackage{graphicx} % Required for including pictures
\graphicspath{{./pictures/}} % Specifies the directory where pictures are stored

\usepackage{lipsum} % Inserts dummy text

\usepackage{tikz} % Required for drawing custom shapes
\usetikzlibrary{calc,backgrounds}

\usepackage{enumitem} % Customize lists
%\setlist{noitemsep} % Reduce spacing between bullet points and numbered lists
%\setlist[itemize]{topsep=0pt} % Reduce spacing before \begin{itemize}

\usepackage{booktabs} % Required for nicer horizontal rules in tables

\usepackage{xcolor} % Required for specifying colors by name
\definecolor{prpl}{RGB}{150, 120, 182} % Define the purple color used for highlighting throughout the book

%----------------------------------------------------------------------------------------
%	FONTS
%----------------------------------------------------------------------------------------

%\usepackage{avant} % Use the Avantgarde font for headings
%\usepackage{times} % Use the Times font for headings
%\usepackage{mathptmx} % Use the Adobe Times Roman as the default text font together with math symbols from the Sym­bol, Chancery and Com­puter Modern fonts

\usepackage{microtype} % Slightly tweak font spacing for aesthetics
\usepackage{cmap}
\usepackage[utf8]{inputenc} % Required for including letters with accents
\usepackage[T2A]{fontenc} % Use 8-bit encoding that has 256 glyphs
\usepackage[english, russian]{babel}

%----------------------------------------------------------------------------------------
%	INDEX
%----------------------------------------------------------------------------------------

\usepackage{calc} % For simpler calculation - used for spacing the index letter headings correctly
\usepackage[xindy]{imakeidx}
\indexsetup{level=\chapter}
\makeindex[program=texindy, options=-M mystyle.xdy -L russian -C utf8]
% the command is 
% texindy -M mystyle.xdy -L russian -C utf8 GOS-Book.idx

\makeatletter
\newcommand{\rindex}[2][\imki@jobname]{%
	\index[#1]{\detokenize{#2}}%
}
\makeatother

%----------------------------------------------------------------------------------------
%	MAIN TABLE OF CONTENTS
%----------------------------------------------------------------------------------------

\usepackage{titletoc} % Required for manipulating the table of contents

\contentsmargin{0cm} % Removes the default margin

%Part text styling
\titlecontents{part}[0cm]
{\addvspace{5pt}\centering\large\bfseries}
{}
{}
{}

\addtocontents{toc}{\protect\setcounter{tocdepth}{0}} % only show up to \chapters in the ToC

% Chapter text styling
\titlecontents{chapter}[0.6cm] % Indentation
{\addvspace{5pt}\large\sffamily} % Spacing and font options for chapters
{\contentslabel[\large\thecontentslabel]{0.6cm}} % Chapter number
{}  
{\large\sffamily\titlerule*[.5pc]{.}\;\thecontentspage} % Page number

% Section text styling
\titlecontents{section}[0.6cm] % Indentation
{\addvspace{3pt}\sffamily} % Spacing and font options for sections
{\contentslabel[\thecontentslabel]{0.6cm}} % Section number
{}
{\sffamily\titlerule*[.5pc]{.}\;\thecontentspage} % Page number
[]

% Subsection text styling
\titlecontents{subsection}[0.6cm] % Indentation
{\addvspace{1pt}\sffamily\small} % Spacing and font options for subsections
{\contentslabel[\thecontentslabel]{1.25cm}} % Subsection number
{}
{\titlerule*[.5pc]{.}\;\thecontentspage} % Page number
[]

% List of figures
\titlecontents{figure}[0em]
{\addvspace{-5pt}\sffamily}
{\thecontentslabel\hspace*{1em}}
{}
{\titlerule*[.5pc]{.}\;\thecontentspage}
[]

% List of tables
\titlecontents{table}[0em]
{\addvspace{-5pt}\sffamily}
{\thecontentslabel\hspace*{1em}}
{}
{\titlerule*[.5pc]{.}\;\thecontentspage}
[]

%----------------------------------------------------------------------------------------
%	MINI TABLE OF CONTENTS IN PART HEADS
%----------------------------------------------------------------------------------------

\addtocontents{ptc}{\protect\setcounter{tocdepth}{2}}

% Chapter text styling
\titlecontents{lchapter}[0em] % Indenting
{\addvspace{10pt}\large\sffamily\bfseries} % Spacing and font options for chapters
{\color{prpl}\contentslabel[\Large\thecontentslabel]{1.25cm}\color{prpl}} % Chapter number
{}  
{\color{prpl}\large\sffamily\bfseries\;\titlerule*[.5pc]{.}\;\thecontentspage} % Page number

% Section text styling
\titlecontents{lsection}[0em] % Indenting
{\sffamily\small} % Spacing and font options for sections
{\contentslabel[\thecontentslabel]{1.25cm}} % Section number
{}
{\sffamily\small\;\titlerule*[.5pc]{.}\;\thecontentspage}

% Subsection text styling
\titlecontents{lsubsection}[.5em] % Indentation
{\normalfont\footnotesize\sffamily} % Font settings
{}
{}
{\normalfont\footnotesize\sffamily\;\titlerule*[.5pc]{.}\;\thecontentspage}

%----------------------------------------------------------------------------------------
%	PAGE HEADERS
%----------------------------------------------------------------------------------------

\usepackage{fancyhdr} % Required for header and footer configuration

\pagestyle{fancy} % Enable the custom headers and footers

%\renewcommand{\chaptermark}[1]{\markboth{\ifnum\value{secnumdepth}>-1 \sffamily\small #1 \fi}{}} % Chapter text font settings

% \if for appendix
\makeatletter
\newcommand{\inappendix}{TT\fi\expandafter\ifx\@chapapp\appendixname}
\makeatother
% page headers
\makeatletter
\renewcommand{\chaptermark}[1]{
	\if\inappendix
	\markboth{#1}{}
	\else
		\if@mainmatter
		\markboth{\ifnum\value{secnumdepth}>-1 \chaptertitlename\thechapter \else #1 \fi}{}
		\else
		\markboth{#1}{}
		\fi
	\fi
}
\makeatother

\renewcommand{\sectionmark}[1]{\markright{\thesection\hspace{5pt}#1}{}} % Section text font settings

\fancyhf{} % Clear default headers and footers 
\fancyhead[LE,RO]{\sffamily\normalsize\thepage} % Font setting for the page number in the header
\fancyhead[LO]{\nouppercase{\footnotesize\sffamily \rightmark}} % Print the nearest section name on the left side of odd pages
\fancyhead[RE]{\nouppercase{\footnotesize\sffamily \leftmark}} % Print the current chapter name on the right side of even pages
\renewcommand{\headrulewidth}{0.5pt} % Width of the rule under the header
\addtolength{\headheight}{2.5pt} % Increase the spacing around the header slightly
\renewcommand{\footrulewidth}{0pt} % Removes the rule in the footer
\fancypagestyle{plain}{\fancyhead{}\renewcommand{\headrulewidth}{0pt}} % Style for when a plain pagestyle is specified

% Removes the header from odd empty pages at the end of chapters
\makeatletter
\renewcommand{\cleardoublepage}{
\clearpage\ifodd\c@page\else
\hbox{}
\vspace*{\fill}
\thispagestyle{empty}
\newpage
\fi}

\indexsetup{othercode={\pagestyle{fancy}}}

%----------------------------------------------------------------------------------------
%	THEOREM STYLES
%----------------------------------------------------------------------------------------

\usepackage{amsmath,amsfonts,amssymb,amsthm} % For math equations, theorems, symbols, etc

\newcommand{\intoo}[2]{\mathopen{]}#1\,;#2\mathclose{[}}
\newcommand{\ud}{\mathop{\mathrm{{}d}}\mathopen{}}
\newcommand{\intff}[2]{\mathopen{[}#1\,;#2\mathclose{]}}
\newtheorem{notation}{Notation}[chapter]

% Boxed/framed environments
\newtheoremstyle{prplnumbox}% % Theorem style name
{0pt}% Space above
{0pt}% Space below
{\normalfont}% % Body font
{}% Indent amount
{\small\bf\sffamily\color{prpl}}% % Theorem head font
{.}% Punctuation after theorem head
{0.25em}% Space after theorem head
{\small\sffamily\color{prpl}\thmname{#1}\thmnumber{\@ifnotempty{#1}{}\@upn{\nobreakspace#2}}% Theorem text (e.g. Theorem 2.1)
\thmnote{\nobreakspace\the\thm@notefont\sffamily\bfseries\color{black}(#3)}} % Optional theorem note
\renewcommand{\qedsymbol}{$\blacksquare$}% Optional qed square

\newtheoremstyle{blacknumex}% Theorem style name
{5pt}% Space above
{5pt}% Space below
{\normalfont}% Body font
{} % Indent amount
{\small\bf\sffamily}% Theorem head font
{.}% Punctuation after theorem head
{0.25em}% Space after theorem head
{\small\sffamily{\qedsymbol}\nobreakspace\thmname{#1}\nobreakspace\thmnumber{\@ifnotempty{#1}{}\@upn{#2}}% Theorem text (e.g. Theorem 2.1)
\thmnote{\nobreakspace\the\thm@notefont\sffamily\bfseries(#3)}}% Optional theorem note

\newtheoremstyle{blacknumbox} % Theorem style name
{0pt}% Space above
{0pt}% Space below
{\normalfont}% Body font
{}% Indent amount
{\small\bf\sffamily}% Theorem head font
{.}% Punctuation after theorem head
{0.25em}% Space after theorem head
{\small\sffamily\thmname{#1}\nobreakspace\thmnumber{\@ifnotempty{#1}{}\@upn{#2}}% Theorem text (e.g. Theorem 2.1)
\thmnote{\nobreakspace\the\thm@notefont\sffamily\bfseries(#3)}}% Optional theorem note

% Non-boxed/non-framed environments
\newtheoremstyle{prplnum}% % Theorem style name
{5pt}% Space above
{5pt}% Space below
{\normalfont}% % Body font
{}% Indent amount
{\small\bf\sffamily\color{prpl}}% % Theorem head font
{.}% Punctuation after theorem head
{0.25em}% Space after theorem head
{\small\sffamily\color{prpl}\thmname{#1}\nobreakspace\thmnumber{\@ifnotempty{#1}{}\@upn{#2}}% Theorem text (e.g. Theorem 2.1)
\thmnote{\nobreakspace\the\thm@notefont\sffamily\bfseries(#3)}} % Optional theorem note

\newtheoremstyle{note}%
{3pt}% Space above1
{3pt}% Space below1
{}% Body font
{}% Indent amount2
{\bfseries}% Theorem head font
{.}% Punctuation after theorem head
{.5em}% Space after theorem head3
{}%
\makeatother

%----------------------------------------------------------------------------------------
%	DEFINITION OF COLORED BOXES
%----------------------------------------------------------------------------------------

\RequirePackage[framemethod=default]{mdframed} % Required for creating the theorem, definition, exercise and corollary boxes

% Theorem box
\newmdenv[skipabove=7pt,
skipbelow=7pt,
backgroundcolor=black!5,
linecolor=prpl,
innerleftmargin=5pt,
innerrightmargin=5pt,
innertopmargin=5pt,
leftmargin=0cm,
rightmargin=0cm,
innerbottommargin=5pt, 
linewidth=1pt]{tBox}

% Exercise box	  
\newmdenv[skipabove=7pt,
skipbelow=7pt,
rightline=false,
leftline=true,
topline=false,
bottomline=false,
backgroundcolor=prpl!10,
linecolor=prpl,
innerleftmargin=5pt,
innerrightmargin=5pt,
innertopmargin=5pt,
innerbottommargin=5pt,
leftmargin=0cm,
rightmargin=0cm,
linewidth=4pt]{eBox}	

% Definition box
\newmdenv[skipabove=7pt,
skipbelow=7pt,
rightline=false,
leftline=true,
topline=false,
bottomline=false,
linecolor=prpl,
innerleftmargin=5pt,
innerrightmargin=5pt,
innertopmargin=0pt,
leftmargin=0cm,
rightmargin=0cm,
linewidth=4pt,
innerbottommargin=0pt]{dBox}	

% Corollary box
\newmdenv[skipabove=7pt,
skipbelow=7pt,
rightline=false,
leftline=true,
topline=false,
bottomline=false,
linecolor=gray,
backgroundcolor=black!5,
innerleftmargin=5pt,
innerrightmargin=5pt,
innertopmargin=5pt,
leftmargin=0cm,
rightmargin=0cm,
linewidth=4pt,
innerbottommargin=5pt]{cBox}

% Creates an environment for each type of theorem and assigns it a theorem text style from the "Theorem Styles" section above and a colored box from above

% Defines the theorem text style for each type of theorem to one of the three styles above

\theoremstyle{blacknumbox}
\newtheorem{defnT}{Определение}[chapter]
\renewcommand{\thedefnT}{\arabic{defnT}}
\newcommand{\theHdefnT}{\thechapter.\arabic{defnT}}
\newenvironment{defn}{\begin{dBox}\begin{defnT}}{\end{defnT}\end{dBox}}	
\newcounter{defn}

\newtheorem{defnnT}{Определение} %штрихованное.
\renewcommand{\thedefnnT}{\arabic{defnT}'}
\newcommand{\theHdefnnT}{\thechapter.\arabic{defnnT}'}
\newenvironment{defnn}{\begin{dBox}\begin{defnnT}}{\end{defnnT}\end{dBox}}	
\newcounter{defnn}

\theoremstyle{prplnumbox}
\newtheorem{thmT}{Теорема}[chapter]
\renewcommand{\thethmT}{\arabic{thmT}}
\newcommand{\theHthmT}{\thechapter.\arabic{thmT}}
\newenvironment{thm}{\begin{eBox}\begin{thmT}}{\end{thmT}\end{eBox}}
\newcounter{thm}

\newtheorem{thmnT}{Теорема}[chapter] %штрихованное.
\renewcommand{\thethmnT}{\arabic{thmT}'}
\newcommand{\theHthmnT}{\thechapter.arabic{thmnT}'}
\newenvironment{thmn}{\begin{eBox}\begin{thmnT}}{\end{thmnT}\end{eBox}}
\newcounter{thmn}

\newtheorem{lemmT}{Лемма}[chapter]
\renewcommand{\thelemmT}{\arabic{lemmT}}
\newcommand{\theHlemmT}{\thechapter.\arabic{lemmT}}
\newenvironment{lemm}{\begin{eBox}\begin{lemmT}}{\end{lemmT}\end{eBox}}
\newcounter{lemm}

\newtheorem{lemmnT}{Лемма}[chapter] %штрихованное.
\renewcommand{\thelemmnT}{\arabic{lemmT}'}
\newcommand{\theHlemmnT}{\thechapter.\arabic{lemmnT}'}
\newenvironment{lemmn}{\begin{eBox}\begin{lemmnT}}{\end{lemmnT}\end{eBox}}
\newcounter{lemmn}

\newtheorem{sttT}{Утверждение}[chapter]
\renewcommand{\thesttT}{\arabic{sttT}}
\newcommand{\theHstt}{\thechapter.\arabic{sttT}}
\newenvironment{stt}{\begin{eBox}\begin{sttT}}{\end{sttT}\end{eBox}}
\newcounter{stt}

\newtheorem{axiomeT}{Аксиома}[chapter]
\renewcommand{\theaxiomeT}{\arabic{axiomeT}}
\newcommand{\theHaxiomeT}{\thechapter.\arabic{axiomeT}}
\newenvironment{axiome}{\begin{eBox}\begin{axiomeT}}{\end{axiomeT}\end{eBox}}
\newcounter{axiome}

\newtheorem{axiomenT}{Аксиома}[chapter] %штрихованное.
\renewcommand{\theaxiomenT}{\arabic{axiomeT}'}
\newcommand{\theHaxiomenT}{\thechapter.\arabic{axiomenT}'}
\newenvironment{axiomen}{\begin{eBox}\begin{axiomenT}}{\end{axiomenT}\end{eBox}}
\newcounter{axiomen}

\theoremstyle{blacknumbox}
\newtheorem{consT}{Следствие}[chapter]
\renewcommand{\theconsT}{\arabic{consT}}
\newcommand{\theHconsT}{\thechapter.\arabic{consT}}
\newenvironment{cons}{\begin{cBox}\begin{consT}}{\end{consT}\end{cBox}}	
\newcounter{cons}

\newtheorem{consnT}{Cледствие}[chapter] %штрихованное.
\renewcommand{\theconsnT}{\arabic{consT}'}
\newcommand{\theHconsnT}{\thechapter.\arabic{consnT}'}
\newenvironment{consn}{\begin{cBox}\begin{consnT}}{\end{consnT}\end{cBox}}	
\newcounter{consn}

\theoremstyle{blacknumex}  
\newtheorem{exmplT}{Пример}[chapter]
\renewcommand{\theexmplT}{\arabic{exmplT}}
\newcommand{\theHexmplT}{\thechapter.\arabic{exmplT}}
\newenvironment{exmpl}{\pushQED{\qed}\begin{exmplT}}{\popQED\end{exmplT}}
\newcounter{exmpl}

\theoremstyle{prplnumbox}
\newtheorem{exercT}{Упражнение}[chapter]
\renewcommand{\theexercT}{\arabic{exercT}}
\newcommand{\theHexercT}{\thechapter.\arabic{exercT}}
\newenvironment{exerc}{\begin{eBox}\begin{exercT}}{\hfill{\color{prpl}}\end{exercT}\end{eBox}}	
\newcounter{exerc}


\newtheorem*{notionT}{Замечание}
\newenvironment{notion}{\begin{tBox}\begin{notionT}}{\end{notionT}\end{tBox}}	

\numberwithin{equation}{chapter}
\renewcommand{\theequation}{\arabic{equation}}
\newcommand{\theHequation}{\thechapter.\arabic{equation}}

\newenvironment{solution}
  {\begin{proof}[Решение.]}
  {\end{proof}}

%\renewcommand\qedsymbol{$\triangle$}

%----------------------------------------------------------------------------------------
%	REMARK ENVIRONMENT
%----------------------------------------------------------------------------------------

\newenvironment{remark}{\par\vspace{10pt}\small % Vertical white space above the remark and smaller font size
\begin{list}{}{
\leftmargin=35pt % Indentation on the left
\rightmargin=25pt}\item\ignorespaces % Indentation on the right
\makebox[-2.5pt]{\begin{tikzpicture}[overlay]
\node[draw=prpl!60,line width=1pt,circle,fill=prpl!25,font=\sffamily\bfseries,inner sep=2pt,outer sep=0pt] at (-15pt,0pt){\textcolor{prpl}{R}};\end{tikzpicture}} % Orange R in a circle
\advance\baselineskip -1pt}{\end{list}\vskip5pt} % Tighter line spacing and white space after remark

%----------------------------------------------------------------------------------------
%	SECTION NUMBERING IN THE MARGIN
%----------------------------------------------------------------------------------------

\makeatletter
\renewcommand{\@seccntformat}[1]{\llap{\textcolor{prpl}{\csname the#1\endcsname}\hspace{1em}}}                    
\renewcommand{\section}{\@startsection{section}{1}{\z@}
{-4ex \@plus -1ex \@minus -.4ex}
{1ex \@plus.2ex }
{\normalfont\large\sffamily\bfseries}}
\renewcommand{\subsection}{\@startsection {subsection}{2}{\z@}
{-3ex \@plus -0.1ex \@minus -.4ex}
{0.5ex \@plus.2ex }
{\normalfont\sffamily\bfseries}}
\renewcommand{\subsubsection}{\@startsection {subsubsection}{3}{\z@}
{-2ex \@plus -0.1ex \@minus -.2ex}
{.2ex \@plus.2ex }
{\normalfont\small\sffamily\bfseries}}                        
\renewcommand\paragraph{\@startsection{paragraph}{4}{\z@}
{-2ex \@plus-.2ex \@minus .2ex}
{.1ex}
{\normalfont\small\sffamily\bfseries}}

%----------------------------------------------------------------------------------------
%	PART HEADINGS
%----------------------------------------------------------------------------------------



% Numbered part in the table of contents
\newcommand{\@mypartnumtocformat}[2]{%
	\setlength\fboxsep{0pt}%
	\noindent\colorbox{prpl!20}{\strut\parbox[c][.7cm]{\ecart}{\color{prpl!70}\Large\sffamily\bfseries\centering#1}}\hskip\esp\colorbox{prpl!40}{\strut\parbox[c][.7cm]{\linewidth-\ecart-\esp}{\Large\sffamily\centering#2}}%
}

% Unnumbered part in the table of contents
\newcommand{\@myparttocformat}[1]{%
	\setlength\fboxsep{0pt}%
	\noindent\colorbox{prpl!40}{\strut\parbox[c][.7cm]{\linewidth}{\Large\sffamily\centering#1}}%
}

\newlength\esp
\setlength\esp{4pt}
\newlength\ecart
\setlength\ecart{1.2cm-\esp}
\newcommand{\thepartimage}{}%
\newcommand{\partimage}[1]{\renewcommand{\thepartimage}{#1}}%
\def\@part[#1]#2{%
	\ifnum \c@secnumdepth >-2\relax%
	\refstepcounter{part}%
	\addcontentsline{toc}{part}{\texorpdfstring{\protect\@mypartnumtocformat{\thepart}{#1}}{\partname~\thepart\ ---\ #1}}
	\else%
	\addcontentsline{toc}{part}{\texorpdfstring{\protect\@myparttocformat{#1}}{#1}}%
	\fi%
	\startcontents%
	\markboth{}{}%
	{\thispagestyle{empty}%
		\begin{tikzpicture}[remember picture,overlay]%
		\node at (current page.north west){\begin{tikzpicture}[remember picture,overlay]%	
			\fill[prpl!20](0cm,0cm) rectangle (\paperwidth,-\paperheight);
			\node[anchor=north] at (4cm,-0.75cm){\color{prpl!40}\resizebox*{!}{0.3\linewidth}{\sffamily\bfseries\thepart}}; 
			\node[anchor=south east] at (\paperwidth-1cm,-\paperheight+1cm){\parbox[t][][t]{10.5cm}{
					\printcontents{l}{0}{\setcounter{tocdepth}{1}}% The depth to which the Part mini table of contents displays headings; 0 for chapters only, 1 for chapters and sections and 2 for chapters, sections and subsections
			}};
			\node[anchor=north east] at (\paperwidth-0.5cm,-1cm){\parbox[t][][t]{14cm}{\strut\raggedleft\color{prpl}\fontsize{30}{30}\sffamily\bfseries#2}};
			\end{tikzpicture}};
\end{tikzpicture}}%
\@endpart}
\def\@spart#1{%
\startcontents%
\phantomsection
{\thispagestyle{empty}%
	\begin{tikzpicture}[remember picture,overlay]%
	\node at (current page.north west){\begin{tikzpicture}[remember picture,overlay]%	
		\fill[prpl!20](0cm,0cm) rectangle (\paperwidth,-\paperheight);
		\node[anchor=north east] at (\paperwidth-1.5cm,-3.25cm){\parbox[t][][t]{15cm}{\strut\raggedleft\color{prpl}\fontsize{30}{30}\sffamily\bfseries#1}};
		\end{tikzpicture}};
\end{tikzpicture}}
\addcontentsline{toc}{part}{\texorpdfstring{%
	\setlength\fboxsep{0pt}%
	\noindent\protect\colorbox{prpl!40}{\strut\protect\parbox[c][.7cm]{\linewidth}{\Large\sffamily\protect\centering #1\quad\mbox{}}}}{#1}}%
\@endpart}
\def\@endpart{\vfil\newpage
\if@twoside
\if@openright
\null
\thispagestyle{empty}%
\newpage
\fi
\fi
\if@tempswa
\twocolumn
\fi}

%----------------------------------------------------------------------------------------
%	CHAPTER HEADINGS
%----------------------------------------------------------------------------------------

\def\@makechapterhead#1{%
	{\noindent
		\if@mainmatter
		\begin{tikzpicture}[remember picture]
		\node (n) at (\Gm@lmargin,-\Gm@tmargin) [ inner sep=3mm, text width={\textwidth}, text opacity=1, font=\huge\sffamily\bfseries, text=black]{\thechapter. #1};
		\begin{scope}[on background layer]
		\draw [line width=2pt, rounded corners=14pt, prpl, fill=prpl!20] (n.north -| current page.east) -| (n.south west) -- (n.south -| current page.east);
		\end{scope}
		\end{tikzpicture}%
		\else
		\begin{tikzpicture}[remember picture]
		\node (n) at (\Gm@lmargin,-\Gm@tmargin) [ inner sep=3mm, text width={\textwidth-0mm}, text opacity=1, font=\huge\sffamily\bfseries, text=black]{#1};
		\begin{scope}[on background layer]
		\draw [line width=2pt, rounded corners=14pt, prpl, fill=prpl!20] (n.north -| current page.east) -| (n.south west) -- (n.south -| current page.east);
		\end{scope}
		\end{tikzpicture}%
		\fi\bigskip\par
}}

%-------------------------------------------

\def\@makeschapterhead#1{%
	\noindent
	\begin{tikzpicture}[remember picture]
	\node (n) at (\Gm@lmargin,-\Gm@tmargin) [ inner sep=3mm, text width={\textwidth-0mm}, text opacity=1, font=\huge\sffamily\bfseries, text=black]{#1};
	\begin{scope}[on background layer]
	\draw [line width=2pt, rounded corners=14pt, prpl, fill=prpl!20] (n.north -| current page.east) -| (n.south west) -- (n.south -| current page.east);
	\end{scope}
	\end{tikzpicture}%
	\bigskip\par
}
\makeatother